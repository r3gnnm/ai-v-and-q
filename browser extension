// Content Script –¥–ª—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∫–≤–∏–∑–æ–≤ –≤ –≤–∏–¥–µ–æ–ø–ª–µ–µ—Ä
// –†–∞–±–æ—Ç–∞–µ—Ç —Å HTML5 video –∏ YouTube

const API_BASE_URL = 'http://localhost:8000';

class VideoQuizOverlay {
    constructor() {
        this.videoElement = null;
        this.overlayContainer = null;
        this.currentVideoId = null;
        this.segments = [];
        this.quizzes = {};
        this.userProgress = {
            completed_segments: [],
            current_segment: 0,
            locked: false
        };
        this.currentSegmentIndex = 0;
        this.quizActive = false;
        
        this.init();
    }
    
    async init() {
        // –ù–∞–π—Ç–∏ –≤–∏–¥–µ–æ—ç–ª–µ–º–µ–Ω—Ç
        this.findVideoElement();
        
        if (!this.videoElement) {
            console.log('Video element not found, retrying...');
            setTimeout(() => this.init(), 1000);
            return;
        }
        
        console.log('Video Quiz Extension: Video element found');
        
        // –°–æ–∑–¥–∞—Ç—å overlay –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        this.createOverlayContainer();
        
        // –°–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π –≤–∏–¥–µ–æ
        this.attachVideoListeners();
        
        // –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å backend (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
        await this.loadVideoData();
    }
    
    findVideoElement() {
        // –ü–æ–∏—Å–∫ HTML5 video —ç–ª–µ–º–µ–Ω—Ç–∞
        this.videoElement = document.querySelector('video');
        
        // –î–ª—è YouTube
        if (window.location.hostname.includes('youtube.com')) {
            this.videoElement = document.querySelector('.html5-main-video');
        }
    }
    
    createOverlayContainer() {
        // –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è overlay
        this.overlayContainer = document.createElement('div');
        this.overlayContainer.id = 'video-quiz-overlay';
        this.overlayContainer.className = 'quiz-overlay-hidden';
        
        // –í—Å—Ç–∞–≤–∏—Ç—å —Ä—è–¥–æ–º —Å –≤–∏–¥–µ–æ
        const videoContainer = this.videoElement.parentElement;
        videoContainer.style.position = 'relative';
        videoContainer.appendChild(this.overlayContainer);
        
        console.log('Quiz overlay container created');
    }
    
    attachVideoListeners() {
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
        this.videoElement.addEventListener('timeupdate', () => {
            this.onTimeUpdate();
        });
        
        // –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–º–æ—Ç–∫–∏ - –±–ª–æ–∫–∏—Ä—É–µ–º –µ—Å–ª–∏ —Ç–µ—Å—Ç –Ω–µ –ø—Ä–æ–π–¥–µ–Ω
        this.videoElement.addEventListener('seeking', (e) => {
            this.onSeeking(e);
        });
        
        // –ü–∞—É–∑–∞/–ø–ª–µ–π
        this.videoElement.addEventListener('pause', () => {
            console.log('Video paused');
        });
    }
    
    async loadVideoData() {
        // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –≤–∏–¥–µ–æ
        const videoId = this.extractVideoId();
        
        if (!videoId) {
            console.log('Could not extract video ID');
            return;
        }
        
        this.currentVideoId = videoId;
        
        try {
            // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ–≥–º–µ–Ω—Ç—ã
            const segmentsResponse = await fetch(`${API_BASE_URL}/video/${videoId}/segments`);
            if (segmentsResponse.ok) {
                this.segments = await segmentsResponse.json();
                console.log(`Loaded ${this.segments.length} segments`);
                
                // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–≤–∏–∑—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞
                for (const segment of this.segments) {
                    const quizResponse = await fetch(`${API_BASE_URL}/segment/${segment.id}/quiz`);
                    if (quizResponse.ok) {
                        const quiz = await quizResponse.json();
                        this.quizzes[segment.id] = quiz;
                    }
                }
                
                // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userId = this.getUserId();
                const progressResponse = await fetch(`${API_BASE_URL}/video/${videoId}/progress/${userId}`);
                if (progressResponse.ok) {
                    this.userProgress = await progressResponse.json();
                }
                
                console.log('Video data loaded successfully');
            }
        } catch (error) {
            console.error('Failed to load video data:', error);
            // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–º–æ
            this.loadMockData();
        }
    }
    
    extractVideoId() {
        // –î–ª—è YouTube
        if (window.location.hostname.includes('youtube.com')) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('v');
        }
        
        // –î–ª—è –¥—Ä—É–≥–∏—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å URL –∏–ª–∏ data-–∞—Ç—Ä–∏–±—É—Ç
        return this.videoElement.getAttribute('data-video-id') || 'local-video';
    }
    
    getUserId() {
        // –ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å user ID
        let userId = localStorage.getItem('video_quiz_user_id');
        if (!userId) {
            userId = 'user-' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('video_quiz_user_id', userId);
        }
        return userId;
    }
    
    onTimeUpdate() {
        if (this.quizActive) return; // –ù–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞
        
        const currentTime = this.videoElement.currentTime;
        
        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏ –∫–æ–Ω—Ü–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞
        const currentSegment = this.segments[this.currentSegmentIndex];
        if (!currentSegment) return;
        
        const segmentEndTime = this.parseTimestamp(currentSegment.end_time);
        
        // –ï—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ –∫–æ–Ω—Ü–∞ —Å–µ–≥–º–µ–Ω—Ç–∞ –∏ –æ–Ω –µ—â—ë –Ω–µ –ø—Ä–æ–π–¥–µ–Ω
        if (currentTime >= segmentEndTime - 0.5 && 
            !this.userProgress.completed_segments.includes(this.currentSegmentIndex)) {
            
            this.pauseVideoAndShowQuiz(this.currentSegmentIndex);
        }
    }
    
    onSeeking(event) {
        // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–µ—Ä–µ–º–æ—Ç–∫–∏ –≤–ø–µ—Ä–µ–¥, –µ—Å–ª–∏ —Å–µ–≥–º–µ–Ω—Ç—ã –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã
        const seekTime = this.videoElement.currentTime;
        
        // –ù–∞–π—Ç–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω–æ–µ –≤—Ä–µ–º—è
        let maxAllowedTime = 0;
        for (let i = 0; i < this.segments.length; i++) {
            if (this.userProgress.completed_segments.includes(i)) {
                maxAllowedTime = this.parseTimestamp(this.segments[i].end_time);
            } else {
                break;
            }
        }
        
        // –ï—Å–ª–∏ –ø–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–º–æ—Ç–∞—Ç—å –¥–∞–ª—å—à–µ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω–æ–≥–æ
        if (seekTime > maxAllowedTime + 1) {
            event.preventDefault();
            this.videoElement.currentTime = maxAllowedTime;
            this.showMessage('‚ùå Complete the current quiz to unlock this section');
        }
    }
    
    pauseVideoAndShowQuiz(segmentIndex) {
        this.videoElement.pause();
        this.quizActive = true;
        
        const segment = this.segments[segmentIndex];
        const quiz = this.quizzes[segment.id];
        
        if (!quiz) {
            console.error('Quiz not found for segment:', segment.id);
            return;
        }
        
        this.renderQuiz(quiz, segmentIndex);
    }
    
    renderQuiz(quiz, segmentIndex) {
        const segment = this.segments[segmentIndex];
        
        let html = `
            <div class="quiz-modal">
                <div class="quiz-header">
                    <h2>üìö Quiz: ${segment.topic_title}</h2>
                    <p class="quiz-summary">${segment.short_summary}</p>
                </div>
                <div class="quiz-body" id="quiz-questions">
        `;
        
        quiz.questions.forEach((question, index) => {
            html += this.renderQuestion(question, index);
        });
        
        html += `
                </div>
                <div class="quiz-footer">
                    <button id="submit-quiz-btn" class="btn-primary">Submit Answers</button>
                    <div id="quiz-result" class="quiz-result-hidden"></div>
                </div>
            </div>
        `;
        
        this.overlayContainer.innerHTML = html;
        this.overlayContainer.className = 'quiz-overlay-visible';
        
        // –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        document.getElementById('submit-quiz-btn').addEventListener('click', () => {
            this.submitQuiz(quiz, segmentIndex);
        });
    }
    
    renderQuestion(question, index) {
        let html = `
            <div class="quiz-question" data-question-id="${question.id}">
                <h3>Question ${index + 1}</h3>
                <p class="question-text">${question.question}</p>
        `;
        
        if (question.type === 'multiple_choice') {
            html += '<div class="options">';
            question.options.forEach((option, i) => {
                html += `
                    <label class="option">
                        <input type="radio" name="q${index}" value="${option}">
                        <span>${option}</span>
                    </label>
                `;
            });
            html += '</div>';
        } else if (question.type === 'true_false') {
            html += `
                <div class="options">
                    <label class="option">
                        <input type="radio" name="q${index}" value="True">
                        <span>True</span>
                    </label>
                    <label class="option">
                        <input type="radio" name="q${index}" value="False">
                        <span>False</span>
                    </label>
                </div>
            `;
        } else if (question.type === 'short_answer') {
            html += `
                <input type="text" class="short-answer-input" name="q${index}" placeholder="Type your answer...">
            `;
        }
        
        html += '</div>';
        return html;
    }
    
    async submitQuiz(quiz, segmentIndex) {
        const answers = this.collectAnswers(quiz);
        
        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –æ—Ç–≤–µ—Ç—ã
        let allCorrect = true;
        let results = [];
        
        for (let i = 0; i < quiz.questions.length; i++) {
            const question = quiz.questions[i];
            const userAnswer = answers[i];
            
            // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –≤ backend
            try {
                const response = await fetch(
                    `${API_BASE_URL}/segment/${this.segments[segmentIndex].id}/answer`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            question_id: question.id,
                            user_answer: userAnswer
                        })
                    }
                );
                
                const result = await response.json();
                results.push(result);
                
                if (!result.correct) {
                    allCorrect = false;
                }
            } catch (error) {
                // Fallback: –ª–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                const correct = userAnswer.toLowerCase().trim() === 
                               question.correct_answer.toLowerCase().trim();
                results.push({ correct });
                if (!correct) allCorrect = false;
            }
        }
        
        if (allCorrect) {
            this.onQuizPassed(segmentIndex);
        } else {
            this.onQuizFailed(segmentIndex, results);
        }
    }
    
    collectAnswers(quiz) {
        const answers = [];
        
        quiz.questions.forEach((question, index) => {
            const questionEl = document.querySelector(`[data-question-id="${question.id}"]`);
            
            if (question.type === 'short_answer') {
                const input = questionEl.querySelector('input[type="text"]');
                answers.push(input.value.trim());
            } else {
                const selected = questionEl.querySelector('input[type="radio"]:checked');
                answers.push(selected ? selected.value : '');
            }
        });
        
        return answers;
    }
    
    async onQuizPassed(segmentIndex) {
        // –û—Ç–º–µ—Ç–∏—Ç—å —Å–µ–≥–º–µ–Ω—Ç –∫–∞–∫ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–π
        this.userProgress.completed_segments.push(segmentIndex);
        this.currentSegmentIndex = segmentIndex + 1;
        
        // –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞ backend
        try {
            await fetch(
                `${API_BASE_URL}/video/${this.currentVideoId}/progress/${this.getUserId()}/complete`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ segment_index: segmentIndex })
                }
            );
        } catch (error) {
            console.error('Failed to update progress:', error);
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —É—Å–ø–µ—Ö
        this.showSuccessMessage();
        
        // –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
        setTimeout(() => {
            this.hideQuiz();
            this.videoElement.play();
        }, 2000);
    }
    
    onQuizFailed(segmentIndex, results) {
        const segment = this.segments[segmentIndex];
        const startTime = this.parseTimestamp(segment.start_time);
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        this.showFailureMessage();
        
        // –ü–µ—Ä–µ–º–æ—Ç–∞—Ç—å –∫ –Ω–∞—á–∞–ª—É —Å–µ–≥–º–µ–Ω—Ç–∞
        setTimeout(() => {
            this.hideQuiz();
            this.videoElement.currentTime = startTime;
            this.videoElement.play();
        }, 3000);
    }
    
    showSuccessMessage() {
        const resultDiv = document.getElementById('quiz-result');
        resultDiv.innerHTML = `
            <div class="result-success">
                <h3>‚úÖ Excellent!</h3>
                <p>All answers correct. Continuing to next segment...</p>
            </div>
        `;
        resultDiv.className = 'quiz-result-visible';
    }
    
    showFailureMessage() {
        const resultDiv = document.getElementById('quiz-result');
        resultDiv.innerHTML = `
            <div class="result-failure">
                <h3>‚ùå Not quite right</h3>
                <p>Please rewatch this segment and try again.</p>
            </div>
        `;
        resultDiv.className = 'quiz-result-visible';
    }
    
    hideQuiz() {
        this.overlayContainer.className = 'quiz-overlay-hidden';
        this.quizActive = false;
    }
    
    showMessage(text) {
        // –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        const msg = document.createElement('div');
        msg.className = 'quiz-toast';
        msg.textContent = text;
        document.body.appendChild(msg);
        
        setTimeout(() => {
            msg.remove();
        }, 3000);
    }
    
    parseTimestamp(timeStr) {
        const parts = timeStr.split(':');
        if (parts.length === 3) {
            return parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseFloat(parts[2]);
        }
        return 0;
    }
    
    loadMockData() {
        // Mock –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
        this.segments = [
            {
                id: 'seg-001',
                start_time: '00:00:00',
                end_time: '00:00:30',
                topic_title: 'Introduction',
                short_summary: 'Welcome and overview'
            }
        ];
        
        this.quizzes = {
            'seg-001': {
                id: 'quiz-001',
                segment_id: 'seg-001',
                questions: [
                    {
                        id: 'q1',
                        type: 'multiple_choice',
                        question: 'What is this video about?',
                        options: ['Topic A', 'Topic B', 'Topic C', 'Topic D'],
                        correct_answer: 'Topic A'
                    }
                ]
            }
        };
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        new VideoQuizOverlay();
    });
} else {
    new VideoQuizOverlay();
}
